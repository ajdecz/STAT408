ifelse(0 %in% time_of_series[1:series[i]],
series[i-1],
series[i]))})) %>%
group_by(game_id,new_series) %>%
mutate(score = sum(score)) %>%
right_join(nfl_dat) %>%
select(-c(series,next_score_pts,time_of_series)) %>%
rename(series = new_series,
next_score_pts = score) %>%
relocate(next_score_pts,.after = last_col()) %>%
relocate(series,.after = game_id) %>%
filter(qtr <= 4) %>%
group_by(game_id) %>%
mutate(time_btw_plays = game_seconds_remaining -
lead(game_seconds_remaining,default = 0))
nfl_reg_cont <- nfl_reg %>%
filter(time_btw_plays != 0)
nfl_ot <- nfl_dat %>%
filter(qtr > 4)
make_time_matrix <- function(x){
tmp <- x %>% cumsum %>% rev
mt <- diag(tmp,nrow = length(tmp))
a <- rep(tmp,times=rev(1:length(tmp))-1)
if(length(a) > 1){
mt[lower.tri(mt)] <- a
mt_tmp <- t(mt)
mt[upper.tri(mt)] <- mt_tmp[upper.tri(mt_tmp)]
}
return(mt)
}
# for (i in unique(nfl_pbp_plays$down)){
#   tmp <- nfl_pbp_plays %>%
#     filter(down == i) %>%
#     pull(distance) %>%
#     quantile(c(1/4,1/2,3/4))
#   assign(paste0("down",i,"_knots"),tmp)
# }
# rm(tmp)
# rm(i)
away_team_pos <- which(nfl_reg_cont$posteam == nfl_reg_cont$away_team)
down_mat <- model.matrix(~ 0 + as.character(down),nfl_reg_cont)
colnames(down_mat) <- c(1,2,3,4,"Free","Kickoff")
down_less_kick_mat <- down_mat[,c("1","2","3","4")]
down_kick_mat <- down_mat[,c("Free","Kickoff")]
distance_mat <- bs(nfl_reg_cont$distance,
degree=3,
knots = c(3,7,10),
Boundary.knots = c(0,46))
distance_mat[away_team_pos,] <- -1 * distance_mat[away_team_pos,]
# distance_mat <- sapply(1:nrow(nfl_pbp_plays),function(i){
#   if (nfl_pbp_plays$down[i] == "Kickoff"){
#     rep(0,6)
#   } else {
#   bs(nfl_pbp_plays$distance[i],
#      degree=3,
#      knots = case_when(nfl_pbp_plays$down[i] == "1" ~ down1_knots,
#                        nfl_pbp_plays$down[i] == "2" ~ down2_knots,
#                        nfl_pbp_plays$down[i] == "3" ~ down3_knots,
#                        nfl_pbp_plays$down[i] == "4" ~ down4_knots),
#      Boundary.knots = c(1,99 -
#                           nfl_pbp_plays$distance[i] +
#                           nfl_pbp_plays$yards_left[i]))
#   }
# }) %>% unlist %>% matrix(ncol=6,byrow=TRUE)
yards_mat <- bs(nfl_reg_cont$yards_left,
degree = 3,
knots = c(30,50,70),
Boundary.knots = c(1,99))
yards_mat[nfl_reg_cont$down == "Kickoff",] <- 0
yards_mat[away_team_pos,] <- -1 * yards_mat[away_team_pos,]
game_time_mat <- bs(nfl_reg_cont$game_seconds_remaining,
degree = 3,
knots = c(900,1800,2700),
Boundary.knots = c(0,3600))
half_time_mat <- bs(nfl_reg_cont$half_seconds_remaining,
degree = 3,
knots = c(120,300,900),
Boundary.knots = c(0,1800))
to_mat <- model.matrix(~ 0 + as.character(home_timeouts_remaining):
as.character(away_timeouts_remaining),
nfl_reg_cont)[,-1]
score_mat <- bs(nfl_reg_cont$score_diff,
degree=3,
knots = c(-8,0,8),
Boundary.knots = c(-63,63))
X <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_mat,yards_mat)) %>%
cbind(half_time_mat) %>%
cbind(to_mat) %>%
cbind(score_mat)
y <- nfl_reg_cont$next_score_pts
game_ids <- nfl_reg_cont$game_id
series_ids <- nfl_reg_cont$series
times <- nfl_reg_cont$time_btw_plays
num <- matrix(0,nrow=ncol(X),ncol=1)
den <- matrix(0,nrow=ncol(X),ncol=ncol(X))
for (game_id in unique(game_ids)){
n_series <- max(series_ids[game_ids == game_id])
for (i in 1:n_series){
print(paste0(game_id," ",i))
X_tm <- X[game_ids == game_id & series_ids == i,,drop=FALSE]
Sigma <- make_time_matrix(times[game_ids == game_id & series_ids == i])
y_tm <- y[game_ids == game_id & series_ids == i]
if (i < n_series){
X_nxt_st <- X[
which(game_ids == game_id & series_ids == i+1) %>% min,
] %>%
matrix(nrow=nrow(X_tm),ncol=ncol(X_tm),byrow=TRUE)
X_tm <- X_tm - X_nxt_st
}
num <- num + t(X_tm) %*% solve(Sigma) %*% y_tm
den <- den + t(X_tm) %*% solve(Sigma) %*% X_tm
}
}
beta <- solve(den) %*% num
View(den)
den %>% det
det(t(X_tm) %*% solve(Sigma) %*% X_tm)
dim(to_mat)
dim(score_mat)
dim(yards_mat)
View(X_tm)
game_id = "2016_01_MIN_TEN"
series = 1
X_tm <- X[game_ids == game_id & series_ids == i,,drop=FALSE]
View(nfl_dat %>% filter(game_id == "2016_01_MIN_TEN"))
X_tm <- X[game_ids == game_id & series_ids == i,]
i = 1
X_tm <- X[game_ids == game_id & series_ids == i,]
Sigma <- make_time_matrix(times[game_ids == game_id & series_ids == i])
den <- den + t(X_tm) %*% solve(Sigma) %*% X_tm
det(den)
det(t(X_tm) %*% solve(Sigma) %*% X_tm)
det(solve(Sigma))
View(Sigma)
View(Sigma/3600)
det(solve(Sigma/3600))
det(t(X_tm) %*% X_tm)
(t(X_tm) %*% X_tm)
(t(X_tm) %*% X_tm) %>% View
library(MASS
)
?rankMatrix
library(Matrix)
rankMatrix(X_tm)
rankMatrix(X)
X <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_mat,yards_mat)) %>%
cbind(half_time_mat) %>%
# cbind(to_mat) %>%
cbind(score_mat)
y <- nfl_reg_cont$next_score_pts
game_ids <- nfl_reg_cont$game_id
series_ids <- nfl_reg_cont$series
times <- nfl_reg_cont$time_btw_plays
num <- matrix(0,nrow=ncol(X),ncol=1)
den <- matrix(0,nrow=ncol(X),ncol=ncol(X))
game_id
i
X_tm <- X[game_ids == game_id & series_ids == i,,drop=FALSE]
det(t(X) %*% x)
det(t(X) %*% X)
det(t(distance_mat) %*% distance_mat)
solve(t(distance_mat) %*% distance_mat)
XX <- down_kick_mat; solve(t(XX) %*% XX)
XX <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)); solve(t(XX) %*% XX)
XX <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_mat,yards_mat)); solve(t(XX) %*% XX)
apply(distance_mat,1,sum) %>% table1
apply(distance_mat,1,sum) %>% table()
apply(yards_mat,1,sum) %>% table()
apply(yards_mat,1,sum) %>% cbind(apply(distance_mat,1,sum))
XX <- down_kick_mat; rankMatrix(XX)
XX <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)); rank(XX)
XX <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)); rank(XX)
XX <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)); rankMatrix(XX)
XX <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)); ncol(XX)
XX <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_mat,yards_mat)); rankMatrix(XX)
ncol(XX)
XX <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_less_kick_mat,yards_mat)); rankMatrix(XX)
dim(XX
)
X <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_mat,yards_mat)) %>%
cbind(half_time_mat) %>%
cbind(to_mat) %>%
cbind(score_mat)
X <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_less_kick_mat,yards_mat)) %>%
cbind(half_time_mat) %>%
cbind(to_mat) %>%
cbind(score_mat)
rankMatrix(X)
ncol(X)
X <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_mat,yards_mat)) %>%
cbind(half_time_mat) %>%
cbind(to_mat) %>%
cbind(score_mat)
rankMatrix(X)
ncol(X)
View(distance_mat)
X <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_mat,yards_mat)) %>%
cbind(half_time_mat) %>%
cbind(to_mat) %>%
cbind(score_mat)
ncol(X)
rankMatrix(X)
nfl_pbp_plays <- nfl_pbp  %>%
# Removing filler rows such as timeout taken, end of qtr, etc
filter(!is.na(play_type) & !is.na(posteam)) %>%
# Specifying down/play ran
mutate(down = case_when(kickoff_attempt == 1 ~ "Kickoff",
extra_point_attempt == 1 ~ "PAT",
two_point_attempt == 1  ~ "Conversion",
is.na(down) ~ "Free Kick",
.default = as.character(down)),
score_diff = score_differential *
ifelse(home_team == posteam,1,-1)) %>%
select(game_id,fixed_drive,home_team,away_team,
posteam,down,ydstogo,yardline_100,
qtr,half_seconds_remaining,game_seconds_remaining,
home_timeouts_remaining,away_timeouts_remaining,
score_diff) %>%
rename(distance = ydstogo,
yards_left = yardline_100) # %>%
nfl_pbp_plays <- nfl_pbp  %>%
# Removing filler rows such as timeout taken, end of qtr, etc
filter(!is.na(play_type) & !is.na(posteam)) %>%
# Specifying down/play ran
mutate(down = case_when(kickoff_attempt == 1 ~ "Kickoff",
extra_point_attempt == 1 ~ "PAT",
two_point_attempt == 1  ~ "Conversion",
is.na(down) ~ "Free Kick",
.default = as.character(down)),
score_diff = score_differential *
ifelse(home_team == posteam,1,-1)) %>%
select(game_id,fixed_drive,home_team,away_team,
posteam,down,ydstogo,yardline_100,
qtr,half_seconds_remaining,game_seconds_remaining,
home_timeouts_remaining,away_timeouts_remaining,
score_diff) %>%
rename(distance = ydstogo,
yards_left = yardline_100) # %>%
library(tidyverse)
nfl_pbp_plays <- nfl_pbp  %>%
# Removing filler rows such as timeout taken, end of qtr, etc
filter(!is.na(play_type) & !is.na(posteam)) %>%
# Specifying down/play ran
mutate(down = case_when(kickoff_attempt == 1 ~ "Kickoff",
extra_point_attempt == 1 ~ "PAT",
two_point_attempt == 1  ~ "Conversion",
is.na(down) ~ "Free Kick",
.default = as.character(down)),
score_diff = score_differential *
ifelse(home_team == posteam,1,-1)) %>%
select(game_id,fixed_drive,home_team,away_team,
posteam,down,ydstogo,yardline_100,
qtr,half_seconds_remaining,game_seconds_remaining,
home_timeouts_remaining,away_timeouts_remaining,
score_diff) %>%
rename(distance = ydstogo,
yards_left = yardline_100) # %>%
make_time_matrix <- function(x){
tmp <- x %>% cumsum %>% rev
mt <- diag(tmp,nrow = length(tmp))
a <- rep(tmp,times=rev(1:length(tmp))-1)
if(length(a) > 1){
mt[lower.tri(mt)] <- a
mt_tmp <- t(mt)
mt[upper.tri(mt)] <- mt_tmp[upper.tri(mt_tmp)]
}
return(mt)
}
# for (i in unique(nfl_pbp_plays$down)){
#   tmp <- nfl_pbp_plays %>%
#     filter(down == i) %>%
#     pull(distance) %>%
#     quantile(c(1/4,1/2,3/4))
#   assign(paste0("down",i,"_knots"),tmp)
# }
# rm(tmp)
# rm(i)
away_team_pos <- which(nfl_reg_cont$posteam == nfl_reg_cont$away_team)
down_mat <- model.matrix(~ 0 + as.character(down),nfl_reg_cont)
colnames(down_mat) <- c(1,2,3,4,"Free","Kickoff")
down_less_kick_mat <- down_mat[,c("1","2","3","4")]
down_kick_mat <- down_mat[,c("Free","Kickoff")]
distance_mat <- bs(nfl_reg_cont$distance,
degree=3,
knots = c(3,7,10),
Boundary.knots = c(0,46))
distance_mat[away_team_pos,] <- -1 * distance_mat[away_team_pos,]
# distance_mat <- sapply(1:nrow(nfl_pbp_plays),function(i){
#   if (nfl_pbp_plays$down[i] == "Kickoff"){
#     rep(0,6)
#   } else {
#   bs(nfl_pbp_plays$distance[i],
#      degree=3,
#      knots = case_when(nfl_pbp_plays$down[i] == "1" ~ down1_knots,
#                        nfl_pbp_plays$down[i] == "2" ~ down2_knots,
#                        nfl_pbp_plays$down[i] == "3" ~ down3_knots,
#                        nfl_pbp_plays$down[i] == "4" ~ down4_knots),
#      Boundary.knots = c(1,99 -
#                           nfl_pbp_plays$distance[i] +
#                           nfl_pbp_plays$yards_left[i]))
#   }
# }) %>% unlist %>% matrix(ncol=6,byrow=TRUE)
yards_mat <- bs(nfl_reg_cont$yards_left,
degree = 3,
knots = c(30,50,70),
Boundary.knots = c(1,99))
yards_mat[nfl_reg_cont$down == "Kickoff",] <- 0
yards_mat[away_team_pos,] <- -1 * yards_mat[away_team_pos,]
game_time_mat <- bs(nfl_reg_cont$game_seconds_remaining,
degree = 3,
knots = c(900,1800,2700),
Boundary.knots = c(0,3600))
half_time_mat <- bs(nfl_reg_cont$half_seconds_remaining,
degree = 3,
knots = c(120,300,900),
Boundary.knots = c(0,1800))
to_mat <- model.matrix(~ 0 + as.character(home_timeouts_remaining):
as.character(away_timeouts_remaining),
nfl_reg_cont)[,-1]
score_mat <- bs(nfl_reg_cont$score_diff,
degree=3,
knots = c(-8,0,8),
Boundary.knots = c(-63,63))
X <- down_kick_mat %>%
cbind(row.kronecker(down_less_kick_mat,distance_mat)) %>%
cbind(row.kronecker(down_less_kick_mat,yards_mat)) %>%
cbind(half_time_mat) %>%
cbind(to_mat) %>%
cbind(score_mat)
y <- nfl_reg_cont$next_score_pts
game_ids <- nfl_reg_cont$game_id
series_ids <- nfl_reg_cont$series
times <- nfl_reg_cont$time_btw_plays
num <- matrix(0,nrow=ncol(X),ncol=1)
den <- matrix(0,nrow=ncol(X),ncol=ncol(X))
game_id = "2016_01_BUF_BAL"
i = 1
X_tm <- X[game_ids == game_id & series_ids == i,,drop=FALSE]
Sigma <- make_time_matrix(times[game_ids == game_id & series_ids == i])
y_tm <- y[game_ids == game_id & series_ids == i]
if (i < n_series){
X_nxt_st <- X[
which(game_ids == game_id & series_ids == i+1) %>% min,
] %>%
matrix(nrow=nrow(X_tm),ncol=ncol(X_tm),byrow=TRUE)
X_tm <- X_tm - X_nxt_st
}
det(t(X_tm) %*% solve(Sigma) %*% X_tm)
num <- matrix(0,nrow=ncol(X),ncol=1)
den <- matrix(0,nrow=ncol(X),ncol=ncol(X))
for (game_id in unique(game_ids)){
n_series <- max(series_ids[game_ids == game_id])
for (i in 1:n_series){
print(paste0(game_id," ",i))
X_tm <- X[game_ids == game_id & series_ids == i,,drop=FALSE]
Sigma <- make_time_matrix(times[game_ids == game_id & series_ids == i])
y_tm <- y[game_ids == game_id & series_ids == i]
if (i < n_series){
X_nxt_st <- X[
which(game_ids == game_id & series_ids == i+1) %>% min,
] %>%
matrix(nrow=nrow(X_tm),ncol=ncol(X_tm),byrow=TRUE)
X_tm <- X_tm - X_nxt_st
}
num <- num + t(X_tm) %*% solve(Sigma) %*% y_tm
den <- den + t(X_tm) %*% solve(Sigma) %*% X_tm
}
}
det(den)
solve(den)
solve(den) %*% num
beta <- solve(den) %*% num
beta
X %*% beta
nfl_reg_cont$exp_pts <- X %*% beta
View(nfl_reg_cont)
nfl_reg_cont$exp_pts <- (X %*% beta)[,1]
min(nfl_reg_cont$exp_pts)
max(nfl_reg_cont$exp_pts)
plot(exp_pts ~ score_diff,nfl_reg_cont)
plot(exp_pts ~ yards_left,nfl_reg_cont)
plot(exp_pts ~ yards_left,nfl_reg_cont %>% filter(down == 1))
rmarkdown::current_document()
library(rmarkdown)
library(rstudioapi)
getActiveDocumentContext()$path
getActiveDocumentContext()$path
getActiveDocumentContext()$path
?getActiveDocumentContext
keeps <- readRDS("C:/Users/mstuart1/OneDrive - Loyola University Chicago/Matt Stuart _ PhD Research/cricketIPL/R/Cricket_Post_Saves.RDS")
keeps$beta
dim(keeps$beta)
plot(keeps$beta[,1,1])
plot(keeps$beta[,1,2])
plot(keeps$beta[,1,3])
plot(keeps$beta[,1,4])
plot(keeps$beta[,2,4])
plot(keeps$beta[,3,4])
dim(keeps$u_bowl)
plot(keeps$u_bowl[,3,4])
plot(keeps$u_bowl[,4,4])
plot(keeps$u_bowl[,1,4])
plot(keeps$u_bowl[,1,1])
ESS(keeps$u_bowl[,1,1])
MCMC::ESS(keeps$u_bowl[,1,1])
mcmcse::ess(keeps$u_bowl[,1,1])
LaplacesDemon::ESS(keeps$u_bowl[,1,1])
LaplacesDemon::ESS(keeps$u_bowl[,1,2])
LaplacesDemon::ESS(keeps$u_bowl[,2,2])
setwd("C:/Users/mstuart1/OneDrive - Loyola University Chicago/Classes/Fall 2024/STAT 408/Code/Review and Basics of R")
# This is a very common R package that easily creates tidy data easier for
# analysis and make beautiful graphs!
library(tidyverse)
# R needs to have a specific place specified to look for documents/data sets to upload.
# To tell R to start looking where the qmd file is, use Session > Set Working Directory > To Source File Location
dat <- read.csv("Data/airfares.csv")
dist <- dat$Distance # this calls the column named Distance in the data frame dat
dat[1:10,] # extract just the first 10 rows, and all columns of the dataset
# naming convention is dataframe$variablename
# dist is now saved in the environment, so you only need to call the object dist when extracting information about Distance from the data frame
mean(dist)
var(dist)
sd(dist)
# We want to calculate a (p)robability from the (norm)al distribution
# Note, by default, R calculates the probability below the entered value
1 - pnorm(3.5,mean=2,sd=2)
pnorm(3.5,mean=2,sd=2,lower.tail=FALSE)
# We want to calculate a (q)uantile from the (norm)al distribution
qnorm(0.35,mean=2,sd=2)
ggplot(data = data.frame(x = c(0, 20)), aes(x)) +
stat_function(fun = dchisq, n = 101, args = list(df = 6)) +
ylab("") +
scale_y_continuous(breaks = NULL) +
theme_bw() +
theme(legend.position = "none")
ggplot(data = data.frame(x = c(-4, 4)), aes(x)) +
stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 1)) +
stat_function(fun = dt, n = 101, args = list(df = 3), aes(colour = "red")) +
ylab("") +
scale_y_continuous(breaks = NULL) +
theme_bw() +
theme(legend.position = "none")
pt(2.2,df=10)
qt(0.8,df=10)
ggplot(data = data.frame(x = c(0, 20)), aes(x)) +
stat_function(fun = dchisq, n = 101, args = list(df = 6)) +
stat_function(fun = df, n = 101, args = list(df1 = 6, df2 = 21), aes(colour="red")) +
ylab("") +
scale_y_continuous(breaks = NULL) +
theme_bw() +
theme(legend.position = "none")
pf(1.3,6,21)
qf(1-0.4,6,21)
qf(0.4,6,21,lower.tail=FALSE)
# We are going to use the R object dist that we previously defined
xbar <- mean(dist)
s <- sd(dist)
n <- length(dist) # counts the number of elements in the inputted vector
alpha <- 0.05
crit <- qt(1-0.05/2,df=n-1)
# c(-1,1) is a vector of the numbers -1 and 1
# This will represent the plus/minus notation when calculating confidence intervals
xbar + c(-1,1) * crit * s / sqrt(n)
# Short cut using R
t.test(dist,conf.level = 0.95)
t.test(dist,mu = 1000,conf.level = 0.95,alternative = "two-sided") # R by default performs a two-sided t-test
t.test(dist,mu = 1000,conf.level = 0.95,alternative = "two.sided") # R by default performs a two-sided t-test
setwd("C:/Users/mstuart1/OneDrive - Loyola University Chicago/Classes/Fall 2024/STAT 408/Code/Simple Linear Regression")
# Don't forget to set the working directory!
library(tidyverse)
bloodpressure <- read.csv("Data/bloodpressure.csv")
# Don't forget to set the working directory!
library(tidyverse)
bloodpressure <- read.csv("Data/bloodpressure.csv")
ggplot(data = bloodpressure,aes(x=Age,y=SBP)) +
geom_point()
# Syntax for regression is lm(Y ~ X,dataframe)
mod <- lm(SBP ~ Age,bloodpressure)
# Syntax for regression is lm(Y ~ X,dataframe)
mod <- lm(SBP ~ Age,bloodpressure)
summary(mod)
98.7147 + 0.9709*50
plot(mod,1) # If mod is a linear model, this produces a residual plot
library(ncvTest)
install.packages("ncvTest")
plot(mod,2) # If mod is a linear model, this is the QQ plot
par(mfrow=c(1,2))
par(mar=c(8,2,8,2))
plot(c(190:270),dnorm(c(190:270),230,10),type="l",col="blue",xlab="",ylab="",yaxt='n',frame.plot=FALSE)
